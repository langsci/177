\providecommand\lsptoprule{}
\renewcommand{\lsptoprule}{\midrule\toprule}
\providecommand\lspbottomrule{}
\renewcommand{\lspbottomrule}{\bottomrule\midrule}

% requires amsmath for \text
\newcommand\mathdash{\text{\normalfont -}}

\newcommand{\todostefan}[1]{\todo[color=green!40]{\footnotesize #1}\xspace}
\newcommand{\todosatz}[1]{\todo[color=red!40]{\footnotesize #1}\xspace}
\newcommand{\todoandrew}[1]{\todo[color=blue!40]{\footnotesize #1}\xspace}
\newcommand{\toaskstefan}[1]{\todo[color=blue!40]{\footnotesize #1}\xspace}

\newcommand{\inlinetodostefan}[1]{\todo[color=green!40,inline]{\footnotesize #1}\xspace}
\newcommand{\inlinetodoandrew}[1]{\todo[color=red!40,inline]{\footnotesize #1}\xspace}

\newcommand{\fixme}{\todo[color=red!40]{\footnotesize fix me}\xspace}


%% \newcommand{\remarkstefan}[1]{\todo[color=green!40]{\footnotesize #1}\xspace}
%% \newcommand{\remarkbjarne}[1]{\todo[color=red!40]{\footnotesize #1}\xspace}

%% \newcommand{\inlineremarkstefan}[1]{\todo[color=green!40,inline]{\footnotesize #1}\xspace}
%% \newcommand{\inlineremarkbjarne}[1]{\todo[color=red!40,inline]{\footnotesize #1}\xspace}

\newcommand{\treeag}{TAG\indextag}

%% is done by package option 
\ifdraft
\proofmodetrue
\fi


%% % taken from covington.sty (check)
%% %\newcounter{lsptempcnt}

%% \newcommand{\mex}[1]{\setcounter{lsptempcnt}{\value{equation}}%
%% \addtocounter{lsptempcnt}{#1}%
%% \arabic{lsptempcnt}}%

%\displaywidowpenalty=10000\relax
%\predisplaypenalty=-200\relax


%\newcommand{\mod}{\textsc{mod}\xspace}  % wegen beamer.cls nicht in abbrev.sty

%\usepackage[figuresright]{rotating}


% http://tex.stackexchange.com/questions/203/how-to-obtain-verbatim-text-in-a-footnote
% somehow does not work
%\usepackage{fancyvrb}

%\newcommand{\tag}{TAG\indextag} % has to be here, conflict with latexbeamer

% mit der Index-Version geht die Silbentrennung nicht
\renewcommand{\word}[1]{\emph{#1}}

%\newcommand{\dom}{\textsc{dom}\xspace}

\newcommand{\prt}{\textsc{prt}}
%\newcommand{\refl}{\textsc{refl}}

%% \newcommand{\snom}{\textit{snom}}
%% \newcommand{\sgen}{\textit{sgen}}
%% \newcommand{\sacc}{\textit{sacc}}

%\usepackage{my-index-shortcuts}

\newcommand{\tesc}{泰尼埃}
\newcommand{\tes}{Tesnière\xspace}
\newcommand{\mel}{Mel'čuk\xspace}
\newcommand{\dom}{\textsc{dom}\xspace}


\newcommand{\page}{}


\let\mc=\multicolumn


% %\exewidth{\exnrfont (34)}
% % should be set up for the whole series in langsci.cls
% \renewcommand{\fnexfont}{\footnotesize\upshape}
% %\let\oldglt\glt
% %\def\glt{\oldglt\justify}
% %\def\glt{\nopagebreak\vskip.17\baselineskip\transfont\parindent0ex}

% \makeatletter
% \def\ea{\ifnum\@xnumdepth=0\begin{exe}\else\begin{xlist}[iv.]\fi\ex}
% \def\eal{\begin{exe}\exnrfont\ex\begin{xlist}[iv.]}

% \def\gll%                  % Introduces 2-line text-and-gloss.
%     {
% %\raggedright%
%         \bgroup
%      \ifx\@gsingle1%           conditionally force single spacing (hpk/MC)
% 	 \def\baselinestretch{1}\@selfnt\fi
% %        \vskip\baselineskip\def\baselinestretch{1}%
% %        \@selfnt\vskip-\baselineskip\fi%
%     \bgroup
%     \twosent
%    }
% \makeatother


% to set the MRSes for scope underspecification
%http://tex.stackexchange.com/questions/218417/replacing-tree-dvips-connect-nodes-in-a-tabular-environment/218458#218458
\usepackage{tcolorbox}
\tcbuselibrary{skins}
% for texlive 2015
\newtcbox{\mybox}[1][]{empty,shrink tight,nobeforeafter,on line,before upper=\vphantom{gM},remember as=#1,top=2pt,bottom=2pt}

% for texlive 2013
%\newtcbox{\mybox}[1][]{enhanced,boxrule=0pt,colframe=white,colback=white,shrink tight,nobeforeafter,on line,before upper=\vphantom{gM},remember as=#1} %,top=3pt,bottom=3pt}
                                %use shorten <=2pt,shorten >=2pt in the pictures.

\newcommand{\mynode}[2]{\mybox[#1]{#2}}


% http://tex.stackexchange.com/questions/218417/replacing-tree-dvips-connect-nodes-in-a-tabular-environment/218458#218458
% Instead of using the package tikzmark, you can define your own \tikzmark being a regular node. There's no need to use tcolorbox package.
\newcommand{\mysubnode}[2]%
    {\tikz[baseline=(#1.base), remember picture]\node[outer sep=0pt, inner sep=0pt] (#1) {#2};}

% http://tex.stackexchange.com/questions/230300/doing-something-like-psframebox-in-tikz#230306
\tikzset{
frbox/.style={
  rounded corners,
  draw,
  thick,
  inner sep=5pt
  }
}
\newcommand\TZbox[1]{\tikz\node[frbox,baseline] {#1};}

\renewcommand{\rm}{\upshape}
\renewcommand{\mathrm}{\text}
\renewcommand{\it}{\itshape}
\renewcommand{\sc}{\scshape}
\renewcommand{\bf}{\bfseries}




% due to pdf readers facing page does not make sense:

%\def\reftextfaceafter{auf der \reftextvario{gegen\"uberliegenden}{n\"achsten} Seite}%
%\def\reftextfacebefore{auf der \reftextvario{gegen\"uberliegenden}{vorigen} Seite}%

\def\reftextfaceafter{在下一页}%
\def\reftextfacebefore{在上一页}%
%\def\reftextfaceafter{on the following page}%
%\def\reftextfacebefore{on the preceeding page}%


% needed for bibtex sorting. Usually provided from the bib file, but this fails for the first run.
\providecommand*{\donothing}[1]{}


% since all the theories are different, we start counting from scratch for every chapter.
% Thanks to Antonio MyP for pointing this out.

%\makeatletter
%\@addtoreset{principle}{chapter}
%\@addtoreset{schema}{chapter}
%\makeatother



% http://tex.stackexchange.com/questions/298031/is-it-possible-to-add-a-command-at-the-beginning-of-a-chapter?noredirect=1#
\pretocmd{\chapter}{% <--- IMPORTANT
    \exewidth{（34）}% <--- IMPORTANT
}{}{}


% The oridingal definition from cgloss4e.
% This is incompatible with \jambox, but does raggedright

%% \def\gllr%                 % Introduces 2-line text-and-gloss.
%%    {\begin{flushleft}
%%      \ifx\@gsingle1%           conditionally force single spacing (hpk/MC)
%%         \vskip\baselineskip\def\baselinestretch{1}%
%%         \@selfnt\vskip-\baselineskip\fi%
%%     \bgroup
%%     \twosentr
%%    }


%%    \gdef\twosentr#1\\ #2\\{% #1 = first line, #2 = second line
%%     \getwords(\lineone,\eachwordone)#1 \\%
%%     \getwords(\linetwo,\eachwordtwo)#2 \\%
%%     \loop\lastword{\eachwordone}{\lineone}{\wordone}%
%%          \lastword{\eachwordtwo}{\linetwo}{\wordtwo}%
%%          \global\setbox\gline=\hbox{\unhbox\gline
%%                                     \hskip\glossglue
%%                                     \vtop{\box\wordone   % vtop was vbox
%%                                           \nointerlineskip
%%                                           \box\wordtwo
%%                                          }%
%%                                    }%
%%          \testdone
%%          \ifnotdone
%%     \repeat
%%     \egroup % matches \bgroup in \gloss
%%    \gl@stop}


% http://tex.stackexchange.com/questions/297068/adding-coordinates-for-connection-between-nodes-in-several-forest-environments
%
% is required because the construction of the curves otherwise results in an enormous bounding box,
% which probably isn't what you want. To see what it does, just delete it from the tree and observe
% the results.

\makeatletter
\newcommand*\ignoreme{\pgf@relevantforpicturesizefalse}
\makeatother

% biblatex stuff
% get rid of initials for Carl J. Pollard and Carl Pollard in the main text:
% Müller is Müller, even if there is a G. Müller
%\ExecuteBibliographyOptions{uniquename=false}
%\ExecuteBibliographyOptions{mincrossrefs=99}



% We do not want italics in the numbers in the headings. St. Mü.
\renewcommand{\headfont}{\upshape}


% gb4e has to use Chinese brackets. They are different and add more space.
%\exewidth{（34）}

% set initial sizes of example number and judgement sizes
%\exewidth{\exnrfont （34）}


% This is done in the langscibook class
%\newindex{sbc}{scx}{scd}{Subject index Chinese}

%% \makeatletter
%% % Subject index in Chinese
%% \newcommand{\footnoteindex@sbc}[2]{\index[sbc]{#2|infn{#1}}}
%% \newcommand{\isc}[1]{%
%%   \if@noftnote%
%%     \index[sbc]{#1}%
%%     \else%
%%     \edef\tempnumber{\thefootnote}%
%%     \expandafter\footnoteindex@sbc\expandafter{\tempnumber}{#1}%
%%     %\indexftn{#1}{\value{footnotemark}}%
%%   \fi%
%% }
%% \makeatother

%% \AtBeginDocument{ % why this?
%% % special addition for separate English and Chinese index
%% %\newindex{sbc}{scx}{scd}{Subject index Chinese}
%% \newindex{sbc}{scx}{scd}{中文术语索引}
%% }

%% % entries for the Chinese index
%% \makeatletter
%% \newcommand{\footnoteindex@sbc}[2]{\index[sbc]{#2|infn{#1}}}
%% \newcommand{\isc}[1]{%
%%   \if@noftnote%
%%     \index[sbc]{#1}%
%%     \else%
%%     \edef\tempnumber{\thefootnote}%
%%     \expandafter\footnoteindex@sbc\expandafter{\tempnumber}{#1}%
%%     %\indexftn{#1}{\value{footnotemark}}%
%%   \fi%
%% }
%% \makeatother


\let\vref\ref
% concerning the vref issue in Chinese

%% check what the unified people have to say on this.
%% This is as deifined in langscibook.cls but with Chinese brackets
% not needed for biblatex
%\bibpunct[: ]{（}{）}{;}{a}{}{,}


% use Chinese brackets
\renewcommand{\pref}[1]{（\ref{#1}）}
\renewcommand{\pmex}[1]{（\mex{#1}）}
\renewcommand{\pmexa}[1]{（\mex{#1}a）}
\renewcommand{\pmexb}[1]{（\mex{#1}b）}



\newcommand{\deter}{\textsc{det}{}\xspace}	%determiner LGR



\newcommand{\questions}[1]{~\newline\vspace*{-5mm}
\memoizeset{disable}%
\tblssy{people}{\hspace{-2em} 思考题}{\setlist{leftmargin=*}#1}}
%\tblssy{people}{Comprehension questions}{#1}}

\newcommand{\exercises}[1]{
%\vspace*{-\baselineskip}%
\memoizeset{disable}%
\tblssy{pencil}{\hspace{-2em} 练习题}{\setlist{leftmargin=*}#1}}
%\tblssy{pencil}{Exercises}{#1}}

% if no questions precede the exercises do not do vspace
\newcommand{\exercisesfirst}[1]{
%\vspace*{-\baselineskip}%
\memoizeset{disable}%
\tblssy{pencil}{\hspace{-2em} 练习题}{\setlist{leftmargin=*}#1}}


\newcommand{\furtherreading}[1]{%~\newline\vspace*{-10mm}
%\vspace*{-\baselineskip}%
\memoizeset{disable}%
\tblssy{book}{\hspace{-2em} 延伸阅读}{\hspace{2em}#1}}

\newcommand{\furtherreadingfirst}[1]{%~\newline\vspace*{-10mm}
%\vspace*{-\baselineskip}%
\memoizeset{disable}%
\tblssy{book}{\hspace{-2em} 延伸阅读}{\hspace{2em}#1}}


\newcommand{\greyboxrest}[1]{
{\memoizeset{disable}%
\begin{mdframed}[style=greyexercise]
#1
\end{mdframed}
}}

\mdfdefinestyle{greyexercisenologo}{%
	everyline=true,ignorelastdescenders=true,
	linewidth=0pt,backgroundcolor=\tblsboxcolor,
	innerleftmargin=5mm, innerrightmargin=5mm, innerbottommargin=5mm, innertopmargin=5mm,
	frametitleaboveskip=15mm, frametitlebelowskip=5mm,frametitlerule=false, repeatframetitle=false
}


%% beim Layout bin ich davon ausgegangen, dass einer Box immer Text vorangeht und folgt. Das war zum Beispiel in Rolands Buch oft so. Ich würde vermuten, dass sich der nötige Abstand ändert, wenn man die Boxen nicht in Text-, sondern in der Umgebung anderer Boxen einbindet.

%% Ich weiß, dass TeX theoretisch erkennen kann, ob das folgende Objekt ein Text-Absatz oder eine Abbildung / andere Box ist. Leider bin ich TeX-mäßig noch nicht weit genug, solche Dinge zu programmieren.

%% Eine manuelle Lösung ist es, ein \vspace*{-\baselineskip} vor der jeweiligen Box einzufügen. Das kannst Du auch generisch lösen, wenn Du Deine Befehle in localcommands.tex entsprechend anpasst.



% get rrid of these morewrite messages:
% https://tex.stackexchange.com/questions/419489/suppressing-messages-to-standard-output-from-package-morewrites/419494#419494
\ExplSyntaxOn
\cs_set_protected:Npn \__morewrites_shipout_ii:
  {
    \__morewrites_before_shipout:
    \__morewrites_tex_shipout:w \tex_box:D \g__morewrites_shipout_box
    \edef\tmp{\interactionmode\the\interactionmode\space}\batchmode\__morewrites_after_shipout:\tmp
  }
\ExplSyntaxOff


% I moved these definitions here (from 3-minimalism.tex) because of extraction of trees
% not used in Chinese edition \edef\innerxsep{\noexpand\hspace*{\pgfkeysvalueof{/pgf/inner xsep}}}%
\newlength\mytextheight
\settototalheight{\mytextheight}{XpX$^0$X$'$}



% Felix 09.06.2020: copy code from the third line into localcommands.tex: https://github.com/langsci/langscibook#defined-environments-commands-etc
\patchcmd{\mkbibindexname}{\ifdefvoid{#3}{}{\MakeCapital{#3} }}{\ifdefvoid{#3}{}{#3 }}{}{\AtEndDocument{\typeout{mkbibindexname could not be patched.}}}
