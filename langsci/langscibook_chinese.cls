%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%      File: langscibook.cls
%%    Author: Language Science Press (http://langsci-press.org)
%%      Date: 2016-01-26 20:54:30 UTC
%%   Purpose: This file defines the basic document class 
%%            for books published with Language Science Press.
%%  Language: LaTeX
%%   Licence: 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{langsci/langscibook}[2016/01/26 Language Science Press]

%% Default values:
\usepackage{xspace}
\newcommand{\lsp}{语言科学出版社\xspace}
%\newcommand{\lsp}{Language Science Press\xspace}
\newcommand{\lsSeriesNumber}{??}
\newcommand{\lsISSN}{??}
\newcommand{\lsISBNdigital}{000-0-000000-00-0}
\newcommand{\lsISBNhardcover}{000-0-000000-00-0}
\newcommand{\lsISBNhardcoverOne}{000-0-000000-00-0}
\newcommand{\lsISBNhardcoverTwo}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcover}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcoverOne}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcoverTwo}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcoverus}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcoverusOne}{000-0-000000-00-0}
\newcommand{\lsISBNsoftcoverusTwo}{000-0-000000-00-0}
\newcommand{\lsBookDOI}{??}
\newcommand{\lsChapterDOI}{??}
\newcommand{\lsURL}{http://langsci-press.org/catalog}
\newcommand{\lsSeries}{eotms}
\newcommand{\lsSpineBreadth}{20mm}
\newcommand{\lsOutput}{long}
\newcommand{\lsFontsize}{11pt}
\newcommand{\lsCopyright}{CC-BY}
\newcommand{\lsBiblatexBackend}{bibtex}
\newif\iflsDraft \lsDraftfalse
\newif\iflsOpenReview \lsOpenReviewfalse
\newif\iflsShowIndex \lsShowIndexfalse

\newif\iflsIndex \lsIndextrue
\newif\iflsBiblatex \lsBiblatextrue
\newif\iflsCollection \lsCollectionfalse
\newif\iflsCollectionChapter \lsCollectionChapterfalse
\newif\iflsCollectionTOCLong \lsCollectionTOCLongfalse
\newif\iflsNewtxmath \lsNewtxmathfalse
\newif\iflsBlackandwhite \lsBlackandwhitefalse
\newif\iflsUscover \lsUscoverfalse

%% Option handling:
\RequirePackage{kvoptions}		% for key-value options
\SetupKeyvalOptions{
	family=langscibook,
	prefix=langscibook@ }
\DeclareStringOption{number}[??]
	\define@key{langscibook}{number}{%
		\renewcommand{\lsSeriesNumber}{#1}}
\DeclareStringOption{issn}[??]
	\define@key{langscibook}{issn}{%
		\renewcommand{\lsISSN}{#1}}
\DeclareStringOption{isbndigital}[000-0-000000-00-0]
	\define@key{langscibook}{isbndigital}{%
		\renewcommand{\lsISBNdigital}{#1}}
\DeclareStringOption{isbnsoftcover}[000-0-000000-00-0]
	\define@key{langscibook}{isbnsoftcover}{%
		\renewcommand{\lsISBNsoftcover}{#1}}
\DeclareStringOption{isbnhardcover}[000-0-000000-00-0]
	\define@key{langscibook}{isbnhardcover}{%
		\renewcommand{\lsISBNhardcover}{#1}}
\DeclareStringOption{url}[http://langsci-press.org/catalog]
	\define@key{langscibook}{url}{%
		\renewcommand{\lsURL}{#1}}
\DeclareStringOption{series}[eotms]
	\define@key{langscibook}{series}{%
		\renewcommand{\lsSeries}{#1}}
\DeclareStringOption{output}[long]
	\define@key{langscibook}{output}{%
		\renewcommand{\lsOutput}{#1}}
\DeclareStringOption{copyright}[CC-BY]
	\define@key{langscibook}{copyright}{%
		\renewcommand{\lsCopyright}{#1}}
\DeclareStringOption{biblatexbackend}[bibtex]
	\define@key{langscibook}{biblatexbackend}{%
		\renewcommand{\lsBiblatexBackend}{#1}}
\DeclareVoidOption{blackandwhite}{
	\lsBlackandwhitetrue} 
\DeclareVoidOption{long}{
	\renewcommand{\lsOutput}{long}}
\DeclareVoidOption{smallfont}{  			
	\renewcommand{\lsFontsize}{10pt}}
\DeclareVoidOption{draftmode}{	% 'draftmode' instead of 'draft' due to undesirable side efects	
	 \lsDrafttrue
	 \overfullrule=5pt	}	% to indicate overfull hboxes
\DeclareVoidOption{openreview}{
	\lsOpenReviewtrue%
	\AtBeginDocument{\renewcommand{\lsISBNdigital}{000-0-000000-00-0}}}
\DeclareVoidOption{noindex}{  			
	\lsIndexfalse}
\DeclareVoidOption{showindex}{  			
	\lsShowIndextrue}
\DeclareVoidOption{biblatex}{  			
	\lsBiblatextrue}
\DeclareVoidOption{bibtex}{  			
	\lsBiblatexfalse}
\DeclareVoidOption{newtxmath}{  			
	\lsNewtxmathtrue}
\DeclareVoidOption{collection}{  			
	\lsCollectiontrue}
\DeclareVoidOption{collectionchapter}{  			
	\lsCollectiontrue%
	\lsCollectionChaptertrue}
\DeclareVoidOption{collectiontoclong}{  			
	\lsCollectiontrue%
	\lsCollectionTOCLongtrue}
\DeclareVoidOption{uscover}{  			
	\lsUscovertrue}
\ProcessKeyvalOptions{langscibook}

\LoadClass[
	fontsize=\lsFontsize,	% default is 11pt
	footnotes=multiple,
	numbers=noenddot,		% no point after last number of chapters/sections
	toc=bibliography,
	index=totoc,
	%chapterprefix=true,
	%draft=yes,
	%appendixprefix
	]{scrbook}

\usepackage{etex}
\reserveinserts{18}
\usepackage{xstring}	% Needed on Lines 114ff and again on 167
\usepackage{graphicx}	% Needed twice
\usepackage{hyphenat}	% Needed twice

\usepackage{tikz} % Needed for covers and advert page
	\usetikzlibrary{positioning}
	\usetikzlibrary{calc}

	
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%      Output types (moved from below)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\lsOutputLong}{long}
\newcommand{\lsOutputShort}{short}
\newcommand{\lsOutputInprep}{inprep}
\newcommand{\lsOutputPaper}{paper}
\newcommand{\lsOutputGuidelines}{guidelines}
\newcommand{\lsOutputCover}{cover}
\newcommand{\lsOutputCoverBOD}{coverbod}
\newcommand{\lsOutputCoverDOB}{coverdob}
\newcommand{\lsOutputCoverCS}{covercreatespace}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Page size and text area:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\newlength{\csspine} 
\newlength{\bodspine}
        \newlength{\seitenbreite}
        \newlength{\seitenhoehe}
        \newlength{\spinewidth}
        \newlength{\totalwidth}
        \newlength{\totalheight}

 \ifx\lsOutput\lsOutputCoverCS % if output = cover; This is the CreateSpace Version 
	\input{./lengths.tex}
 
 	\newlength{\bleed}
 	\setlength{\bleed}{3.175mm}
 	\setlength{\seitenbreite}{169.9mm}
 	\setlength{\seitenhoehe}{244.1mm}
 	
 	\setlength{\spinewidth}{\csspine}			% Create Space Version. Value is in ./localmetadata.tex
 	
 	\usepackage{calc}

 	\setlength{\totalwidth}{\spinewidth+\seitenbreite+\seitenbreite+\bleed+\bleed}
 	\setlength{\totalheight}{\seitenhoehe+\bleed+\bleed}
 	\usepackage[paperheight=\totalheight, paperwidth=\totalwidth]{geometry}
 	\hyphenpenalty 750
 	    
 \else
 
 %% Nested ifx. Here follows the BoD Version
 
  \ifx\lsOutput\lsOutputCoverBOD 
     \usepackage{calc}

  \input{./lengths.tex}
  
  \newlength{\bodfold}
  \newlength{\totalspine}
  \setlength{\bodfold}{8mm}
  \setlength{\seitenbreite}{192mm}
  \setlength{\seitenhoehe}{280mm} % For BOD: Hardcover, Gerader Rücken, Kaschiert, papier 80g/m², weiß
  \setlength{\spinewidth}{\bodspine}         % BoD Version. Value is in ./localmetadata.tex
  \setlength{\totalspine}{\spinewidth+\bodfold+\bodfold} 
  \setlength{\totalwidth}{\spinewidth+\seitenbreite+\seitenbreite}
  %\setlength{\totalheight}{\seitenhoehe}
  \usepackage[paperheight=\seitenhoehe, paperwidth=\totalwidth]{geometry}
  \hyphenpenalty 750
  
 \else 
 
 	\usepackage[ 					% if output != cover
 	papersize={170mm,240mm}
 	,top=27.4mm % TODO nachgemessen, nach Vermassung eigentlich 30mm-16pt = 25.8mm
 	,inner=20.5mm, 
 	,outer=24.5mm
 	%,showframe,pass
 	,marginparwidth=50pt
 	]{geometry}
 \fi
\fi			

\usepackage[
	absolute 		% for absolute positioning in titlepage
	%,showboxes
	]{textpos}
\setlength{\TPHorizModule}{1mm}
\setlength{\TPVertModule}{\TPHorizModule}
\textblockorigin{0mm}{0mm}

\usepackage{pbox}   % boxes with maximum width
	

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Fonts, language and graphics:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{ifxetex}
\ifxetex\else\ClassError{langsci/langscibook}{Please use XeLaTeX!}{}\fi	
\usepackage{amssymb} % has to be loaded before other stuff
% \usepackage{dtklogos}\newcommand{\xelatex}{\XeLaTeX\xspace}	% the XeLaTeX symbol

%\usepackage{fontspec}	% already loaded by XeLaTeX
\PassOptionsToPackage{no-math}{fontspec} % must appear before metalogo or any fontspec stuff; deactivates fontspec's math settings, which is necessary to let newtxmath do the job 
\usepackage{metalogo}\newcommand{\xelatex}{\XeLaTeX\xspace}
\newcommand{\fontpath}{./langsci/fonts/}

\setsansfont[
	%Ligatures={TeX,Common},		% not supported by ttf
	Scale=MatchLowercase,
	Path=\fontpath,
	BoldFont = Arimo-Bold_B.ttf ,
	ItalicFont = Arimo-Italic_B.ttf ,				
	BoldItalicFont = Arimo-BoldItalic_B.ttf 		
	]{Arimo_B.ttf}
		
\setmonofont[
	Ligatures={TeX},Scale=MatchLowercase,Path=\fontpath,
	BoldFont = DejaVuSansMono-Bold.ttf ,
	SlantedFont = DejaVuSansMono-Oblique.ttf ,				
	BoldSlantedFont = DejaVuSansMono-BoldOblique.ttf 		
	]{DejaVuSansMono.ttf}

\setmainfont[
        Ligatures={TeX,Common},
        Path=\fontpath,
        PunctuationSpace=0,
        Numbers={Proportional},
        BoldFont = LinLibertine_RZ_B.otf ,
        ItalicFont = LinLibertine_RI_B.otf ,
        BoldItalicFont = LinLibertine_RZI_B.otf,
        BoldSlantedFont = LinLibertine_RZ_B.otf,
        SlantedFont    = LinLibertine_R_B.otf,
        SlantedFeatures = {FakeSlant=0.25},
        BoldSlantedFeatures = {FakeSlant=0.25},
        SmallCapsFeatures = {FakeSlant=0},
        ]{LinLibertine_R_B.otf}		

\iflsNewtxmath							% some users have problems when installing newtxmath
	\usepackage[libertine]{newtxmath}

	%% following http://tex.stackexchange.com/questions/297328/xelatex-does-not-load-newtxmath-with-linuxlibertine-sometimes
	%% due to a bug in XeTeX; unfortunately this is NOT extensively tested!
	\usepackage{xpatch}
	\xpretocmd{\textsuperscript}
	 {{\sbox0{$\textstyle x$}}}
	 {}{}
	\AtBeginDocument{%
	  \DeclareSymbolFont{operators}{\encodingdefault}{\familydefault}{m}{n}%
	  \SetSymbolFont{operators}{bold}{\encodingdefault}{\familydefault}{b}{n}%
	}	
\fi 	

\let\oldtabular\tabular	% number in tabulars
\let\endoldtabular\endtabular
\renewenvironment{tabular}{\normalfont\addfontfeatures{Numbers=Lining}\selectfont\oldtabular}{\endoldtabular}

%\frenchspacing			
\usepackage[final]{microtype}

  \newcommand{\lsCoverTitleFont}[1]{\sffamily\addfontfeatures{Scale=MatchUppercase}\fontsize{52pt}{16.75mm}\selectfont #1}
  \newcommand{\lsCoverSubTitleFont}{\sffamily\addfontfeatures{Scale=MatchUppercase}\fontsize{25pt}{10mm}\selectfont}
  \newcommand{\lsCoverAuthorFont}{\fontsize{25pt}{12.5mm}\selectfont}
  \newcommand{\lsCoverSeriesFont}{\sffamily\fontsize{17pt}{7.5mm}\selectfont}			% fontsize?
  \newcommand{\lsCoverSeriesHistoryFont}{\sffamily\fontsize{10pt}{5mm}\selectfont}
  \newcommand{\lsInsideFont}{}	% obsolete, see \setmainfont
  \newcommand{\lsDedicationFont}{\fontsize{15pt}{10mm}\selectfont}
  \newcommand{\lsBackTitleFont}{\sffamily\addfontfeatures{Scale=MatchUppercase}\fontsize{25pt}{10mm}\selectfont}
  \newcommand{\lsBackBodyFont}{\lsInsideFont}
  \newcommand{\lsSpineAuthorFont}{\fontsize{16pt}{14pt}\selectfont}
  \newcommand{\lsSpineTitleFont}{\sffamily\fontsize{18pt}{14pt}\selectfont}

\setkomafont{sectioning}{\normalcolor\bfseries}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Colors:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{xcolor}
\input{langsci/seriesinfo/series.def} % \lsSeriesColor, \lsSeriesTitle, \lsISSN and colors are defined here


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Special commands for authors:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% defaults:
\newcommand{\lsBackBody}{Europan lingues es membres del sam familie. Lor separat existentie es un
myth. Por scientie, musica, sport etc, litot Europa usa li sam vocabular. Li
lingues differe solmen in li grammatica, li pronunciation e li plu commun vocabules. Omnicos directe
al desirabilite de un nov lingua franca: On refusa continuar payar custosi traductores.}
\newcommand{\lsBackTitle}{Back Title}

\newcommand{\BackTitle}[1]{\renewcommand{\lsBackTitle}{#1}}
\newcommand{\BackBody}[1]{\renewcommand{\lsBackBody}{#1}} 

\newcommand{\newlineCover}{\\}	% \newline only on cover
\newcommand{\newlineSpine}{\\}	% \newline only on spine
\newcommand{\newlineTOC}{\\}		% \newline only in TOC entry

\newcommand{\lsSpineTitle}{\@title}
\newcommand{\lsSpineAuthor}{\@author}
\newcommand{\SpineTitle}[1]{\renewcommand{\lsSpineTitle}{#1}}
\newcommand{\SpineAuthor}[1]{\renewcommand{\lsSpineAuthor}{#1}} 


%% for imprint:
\def\translator#1{\gdef\@translator{#1}}
\translator{}
\def\typesetter#1{\gdef\@typesetter{#1}}
\typesetter{}
\def\proofreader#1{\gdef\@proofreader{#1}}
\proofreader{}
\def\openreviewer#1{\gdef\@openreviewer{#1}}
\openreviewer{}
\def\illustrator#1{\gdef\@illustrator{#1}}
\illustrator{}
\newcommand{\lsAdditionalFontsImprint}{}
\newcommand{\AdditionalFontImprint}[1]{
	\edef\fontstemp{\lsAdditionalFontsImprint}
	\renewcommand{\lsAdditionalFontsImprint}{\fontstemp, #1}
	}

%\def\@author{\@latex@warning@no@line{No \noexpand\author given}}
\newcommand{\ISBNdigital}[1]{\renewcommand{\lsISBNdigital}{#1}}
\newcommand{\ISBNsoftcover}[1]{\renewcommand{\lsISBNsoftcover}{#1}}
\newcommand{\ISBNhardcover}[1]{\renewcommand{\lsISBNhardcover}{#1}}
\newcommand{\URL}[1]{\renewcommand{\lsURL}{#1}}
\newcommand{\Series}[1]{\renewcommand{\lsSeries}{#1}}
\newcommand{\SeriesNumber}[1]{\renewcommand{\lsSeriesNumber}{#1}}
\newcommand{\BookDOI}[1]{\renewcommand{\lsBookDOI}{#1}}

%% for papers of collections:
\newcommand{\lsCollectionPaperAbstract}{Put abstract here with \string\abstract.}
\newcommand{\abstract}[1]{\renewcommand{\lsCollectionPaperAbstract}{#1}}
\newcommand{\ChapterDOI}[1]{\renewcommand{\lsChapterDOI}{#1}}

\def\epigram#1{\gdef\@epigram{#1}}			% needs to be defined this way to check emptiness
\epigram{}
\def\epigramsource#1{\gdef\@epigramsource{#1}}
\epigramsource{}

%% inside \author:
\renewcommand{\and}{}				
\newcommand{\lastand}{}
\newcommand{\affiliation}[1]{}	

%% to be used below chapter titles
\newcommand{\chaptersubtitle}[1]{
	\vspace*{-2ex}
	{\Large #1}
	\chapterheadendvskip
	\@afterindentfalse
	\@afterheading
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Header and footer:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{datetime}
\usepackage{scrpage2}
\ohead{\headmark}
\ihead{}
\cfoot{}
\ofoot[]{\pagemark}
\iflsDraft
  \ifoot{Draft of \today, \currenttime}
\fi
\iflsOpenReview
  \ifoot{{\color{lsRed}Open review version}. Final version at \url{\lsURL}.}
\fi

\newcommand{\lsPageStyleEmpty}{
	\ohead{}
	\ihead{}
	\cfoot{}
	\ofoot[]{}
}

\renewcommand*{\partpagestyle}{empty}

\pagestyle{scrheadings}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Citation:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Xelatex likes this, must appear before BibLaTeX:
\usepackage[hyphens]{url}
\urlstyle{same}

\iflsBiblatex	% BibLaTeX
	\usepackage[
		natbib=true,
		style=langsci/bst/biblatex-sp-unified,
		citestyle=langsci/bst/sp-authoryear-comp,
		%refsection=chapter,
		maxbibnames=99,
		isbn=false,
		doi=false,
		url=false,
		eprint=false,
		backend=\lsBiblatexBackend,
		indexing=cite,
		\iflsCollection\else
			toc=bib 		% make bibliography appear in toc
		\fi
		]{biblatex}
	\renewcommand{\postnotedelim}{: }%
	\renewcommand{\multicitedelim}{\addsemicolon\space}%  
	\renewcommand{\compcitedelim}{\multicitedelim}
	\DeclareFieldFormat{postnote}{#1}%
	%\renewcommand{\nameyeardelim}{ }%
        \defbibheading{references}{\chapter{References}} 
\else	%BibTeX
	\usepackage{natbib}
	\setlength{\bibsep}{0mm}
	%% unified style sheet for linguistics journals
	%% http://celxj.org/downloads/unified.bst
	\bibliographystyle{./langsci/bst/unified} 
	%% This does not work ...
	% \setcitestyle{
	% notesep={: }, % 2002: 125
	% aysep={~}     % Gazdar 2002
	% }

	%% check what the unified people have to say on this.
	\bibpunct[: ]{(}{)}{;}{a}{}{,}
	%% They do not say anything about citations in the running text.
	%% As was sown in \citew{Meier2002} -> As was shown in Meier (2002), ...
	%% This is what De Gruyter does:
	\let\citew=\citet
	%% This is what Stefan did:
	%\let\citew=\citealt
\fi

\let\cite=\citet 	% in order to prevent inconsistencies between \cite and \citet

%% penalties against widows and orphans in bibliography
%% http://tex.stackexchange.com/questions/297705/atbeginenvironment-does-not-work-with-natbib/297721#297721
\usepackage{etoolbox}
\apptocmd{\thebibliography}{%
\clubpenalty\@M
\@clubpenalty\clubpenalty
\widowpenalty\@M
}
{}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Floats:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{floatrow}					% For adjusting the position of the caption (default is below).
\floatsetup[table]{capposition=top} 	% As for tables, the caption appears above.

%% This sets the default for the positioning of floats
\renewcommand{\fps@figure}{htbp}
\renewcommand{\fps@table}{htbp}

\usepackage{booktabs} % for nicer lines


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Appendices:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appto\appendix{%
	%% format of the appendix title page
	\renewcommand*{\chapterformat}{%
		\mbox{\chapapp~\thechapter\autodot:\enskip}%
	}
	%% format of the TOC entry
	\renewcommand{\addchaptertocentry}[2]{
		\ifstr{#1}{}{%
		\addtocentrydefault{chapter}{}{#2}%
		}{%
		\addtocentrydefault{chapter}{}{\chapapp~#1: #2}%
		}%
	}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Indexes:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iflsIndex
\usepackage{index}
% Wie im Stylefile, aber ohne \MakeUppercase
   \renewenvironment{theindex}{%
		\edef\indexname{\the\@nameuse{idxtitle@\@indextype}}%
		\if@twocolumn
			\@restonecolfalse
		\else
			\@restonecoltrue
		\fi
		\columnseprule \z@
		\columnsep 35\p@
		\twocolumn[%
			\@makeschapterhead{\indexname}%
			\ifx\index@prologue\@empty\else
				\index@prologue
				\bigskip
			\fi
		]%
%        \@mkboth{\MakeUppercase\indexname}%
%                {\MakeUppercase\indexname}%
		\@mkboth{\indexname}%
				{\indexname}%
		\thispagestyle{plain}%
		\parindent\z@
		\parskip\z@ \@plus .3\p@\relax
		\let\item\@idxitem
		\providecommand*\seealso[2]{\emph{see also} ##1}
	}{%
		\if@restonecol
			\onecolumn
		\else
			\clearpage
		\fi
	}

\newcommand{\lsLanguageIndexTitle}{语言索引}	% This can be changed according to the language.
\newcommand{\lsSubjectIndexTitle}{术语索引}
\newcommand{\lsNameIndexTitle}{人名索引}
%\newcommand{\lsLanguageIndexTitle}{Language index}	% This can be changed according to the language.
%\newcommand{\lsSubjectIndexTitle}{Subject index}
%\newcommand{\lsNameIndexTitle}{Name index}

\usepackage{morewrites}

\AtBeginDocument{ % why this?
\makeindex
\newindex{lan}{ldx}{lnd}{\lsLanguageIndexTitle}
% \newindex{aut}{adx}{and}{Name index}
\newindex{sbj}{sdx}{snd}{\lsSubjectIndexTitle}
% special addition for separate English and Chinese index
%\newindex{sbc}{scx}{scd}{Subject index Chinese}
\newindex{sbc}{scx}{scd}{中文术语索引}
\renewindex{default}{adx}{and}{\lsNameIndexTitle} %biblatex can only deal with the default index
\newindex{wrd}{wdx}{wnd}{Expression index}
\newindex{rwrd}{rdx}{rnd}{Reverse expression index}
}

\indexproofstyle{\setlength{\overfullrule}{0pt}\raggedright\footnotesize}

%% \index inside footnote
\def\infn#1#2{%
	\hyperpage{#2}n#1%
}%
\newcommand{\footnoteindex}[2]{\index{#2|infn{#1}}}
\newcommand{\footnoteindex@sbj}[2]{\index[sbj]{#2|infn{#1}}}
\newcommand{\footnoteindex@lan}[2]{\index[lan]{#2|infn{#1}}}
\newcommand{\footnoteindex@wrd}[2]{\index[wrd]{#2|infn{#1}}}

% Subject index in Chinese
\newcommand{\footnoteindex@sbc}[2]{\index[sbc]{#2|infn{#1}}}


\fi

\newcommand{\ia}[1]{\if@noftnote%
\index{#1}%
\else%
\edef\tempnumber{\thefootnote}%
\expandafter\footnoteindex\expandafter{\tempnumber}{#1}%
% \index{#1|fn{\thefootnote}}%
\fi%
}

\newcommand{\is}[1]{\if@noftnote%
\index[sbj]{#1}%
\else%
\edef\tempnumber{\thefootnote}%
\expandafter\footnoteindex@sbj\expandafter{\tempnumber}{#1}%
%\indexftn{#1}{\value{footnotemark}}%
\fi%
}

\newcommand{\isc}[1]{%
  \if@noftnote%
    \index[sbc]{#1}%
    \else%
    \edef\tempnumber{\thefootnote}%
    \expandafter\footnoteindex@sbc\expandafter{\tempnumber}{#1}%
    %\indexftn{#1}{\value{footnotemark}}%
  \fi%
}

%% \index[lan] für Einträge in separaten Index
\newcommand{\il}[1]{%
\if@noftnote%
\index[lan]{#1}%
\else%
\edef\tempnumber{\thefootnote}%
\expandafter\footnoteindex@lan\expandafter{\tempnumber}{#1}%
\fi%
}

% \iflsDraft
%   \usepackage{showidx} 	% Doesn't work with multiple indexes?
% \fi



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Hyperref:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[
	bookmarks=true,bookmarksopen=true,bookmarksopenlevel=1,%
	bookmarksdepth=5,
	bookmarksnumbered=true,
	hyperindex=true,%
	breaklinks=true,
	draft=false,
	plainpages=false,
	pdfusetitle=true,  % puts author and title in automatically, maybe only in final mode?
	pdfkeywords={},
	pdfpagelayout=TwoPageRight,   % first page is separate
	%ps2pdf=true
	]{hyperref}

%% xelatex hates this.
%\usepackage{breakurl} 	

%% add hyperlinks for DOIs in bibliography; must appear after hyperref
\usepackage{doi}
\renewcommand{\doitext}{DOI:}
\iflsBiblatex
\renewbibmacro*{finentry}{\finentry
	\iffieldundef{doi}
		  {}
		  { {\color{lsGuidelinesGray}\doi{\thefield{doi}}}}
}
%\DeclareFieldFormat{doi}{{\color{lsGuidelinesGray}\doi{#1}}}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Cover:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{pst-barcode}					% for generating bar codes
\newcommand{\logopath}{./langsci/graphics}
\newcommand{\lsCoverFontColor}{white}
\newcommand{\lsCoverBlockColor}{\lsSeriesColor}
\newcommand{\lsEditorPrefix}{}
\newcommand{\lsEditorSuffix}{}   

\iflsCollection  	% for collections: set \lsEditorSuffix depending on \@author
\AtBeginDocument{
	\onlyAuthor
	\renewcommand{\newlineCover}{}
	\renewcommand{\newlineSpine}{}	
	\IfSubStr{\@author}{\&}	 	% if \@author contains \&
		{\renewcommand{\lsEditorSuffix}{(eds.)}}
		{\IfSubStr{\@author}{,}	% if \@author contains ,
			{\renewcommand{\lsEditorSuffix}{(eds.)}}
			{\renewcommand{\lsEditorSuffix}{(ed.)}}}
}
\else
\fi

\newcommand{\lsCoverBlock}{
	\begin{textblock}{155}(7.6,7.5)
	\color{\lsCoverBlockColor}
	\raggedright\rule{155mm}{225mm}
	\end{textblock}
	\iflsDraft
	   \begin{textblock}{155}(30,80)
		 \color{lsLightGray}
		 \rotatebox{40}{
			\begin{tabular}{c}
			\scalebox{10}{DRAFT}\\
			of \today, \currenttime
			\end{tabular}}
	   \end{textblock}
	\fi
	\iflsOpenReview
		\iflsDraft
			\ClassError{langsci/langscibook}{Open review mode not compatible with draft mode. Please disable one of them}{}	
		\fi
		\begin{textblock}{170}(-20,75)
			\rotatebox{30}{
			\colorbox{red}{
			\parbox[c][15ex][c]{220mm}{\centering\lsCoverTitleFont\color{white}Open Review\\[-0.1ex]}
			% \begin{tabular}{c}
			% 	~\\
			% 	\scalebox{6}{\color{red}Open Review}\\[-0.5ex]
			% 	~%version of \today, \currenttime
			% \end{tabular}
			}
			}
	   \end{textblock}
	\fi}

\newcommand{\lsCoverTitleAuthor}{
	\renewcommand{\and}{}
	\renewcommand{\lastand}{}
	\renewcommand{\newlineCover}{\\}
	\renewcommand{\newlineSpine}{}
	\lsCoverBlock

	\begin{textblock}{140}(15,17.5)
	\color{\lsCoverFontColor}
	\raggedright
	{\lsCoverTitleFont{\@title\\}}

	\ifx\@subtitle\empty
	\else \vspace{8mm} {\lsCoverSubTitleFont \@subtitle\\}
	\fi

	\vspace{11.2mm} % 20mm - 25pt
 
	\raggedright
	{\lsCoverAuthorFont 
		\lsEditorPrefix\@author\\}
	\end{textblock}}

\newcommand{\lsCoverSeries}{
	\begin{textblock}{95}(7.4,209)
	\color{white}
	\raggedright\rule{3.6mm}{3.5mm}
	\color{\lsCoverFontColor}
	\hspace{3mm}\parbox[t]{85mm}{\raggedright\lsCoverSeriesFont   
		\lsSeriesTitle\\}
	\end{textblock}}

\newcommand{\lsCoverLogo}{		
	\begin{textblock}{33}(124.6,205)
		\raggedright\IfFileExists{\logopath/langsci_logo_nocolor.pdf}{\includegraphics{\logopath/langsci_logo_nocolor.pdf}}{langsci logo}  
	\end{textblock}}

\newcommand{\lsFrontPage}{		% Front page
	\lsCoverBlock
	\lsCoverTitleAuthor
	\lsCoverSeries
	\lsCoverLogo}

\newcommand{\lsSchmutztitel}{	% Schmutztitel
	\lsCoverBlock
	\lsCoverTitleAuthor
	\lsCoverLogo}

%\usepackage{pdfpages}
\newcommand{\lsAdvertisement}{
%	\includepdf[pages={1}]{langsci/graphics/didyoulikethisbook.pdf}
	\include{langsci/graphics/didyoulikethisbook}
}

\newcommand{\lsBackPage}{		% Back page
	\lsCoverBlock

	\begin{textblock}{115}(15,24)  % 30mm-6mm
	\color{white}
	{\raggedright
	 \lsBackTitleFont 
	 \lsBackTitle \\ \null} 

	\lsBackBodyFont

	\noindent 
	\lsBackBody
	\end{textblock}

	\begin{textblock}{40}(105,200)
	\lsBackBodyFont\sffamily
	\colorbox{white}{%
	\begin{pspicture}(0,0)(4.1,1in)
	\psbarcode[transx=0.4,transy=0.3]{\lsISBNdigital}{includetext height=0.7}{isbn}
	\end{pspicture}
	}%	
	\end{textblock}}

\newcommand{\lsSpine}{			% Book spine
	\renewcommand{\newlineSpine}{\\}
	\renewcommand{\newlineCover}{}
	\begin{textblock}{40}(65,0)
	\rotatebox{90}{\color{black}\begin{minipage}[c][\lsSpineBreadth][c]{\paperheight}
		\color{\lsSeriesColor}
		\hspace{7.5mm}
		\IfFileExists{\logopath/langsci_spinelogo_nocolor.pdf}{$\vcenter{\hbox{\includegraphics[angle=-90,origin=c]{\logopath/langsci_spinelogo_nocolor.pdf}}}$}{logo}
		\hspace{15mm} 
		{\lsSpineTitleFont
			\rotatebox[origin=c]{180}{\pbox[c]{150mm}{\lsSpineTitle}}}
		\hspace{13mm}
		{\lsSpineAuthorFont 
			\rotatebox[origin=c]{180}{\pbox[c]{100mm}{\lsSpineAuthor\if\lsEditorSuffix\empty\else\ \lsEditorSuffix\fi}}}
	\end{minipage}} 
	\end{textblock}}

\newcommand{\onlyAuthor}{%		% collection paper
	\renewcommand{\and}{, }% 
	\renewcommand{\lastand}{ \& }%  
	\renewcommand{\affiliation}[1]{}}
\newcommand{\AuthorAffiliation}{
	\renewcommand{\and}{\newline\newline} 
	\renewcommand{\lastand}{\newline\newline} 
	\renewcommand{\affiliation}[1]{\\[0.5ex]{\normalsize ##1}}}
\newcommand{\lsCollectionPaperHeaderAuthor}{{%
	\renewcommand{\newlineCover}{}%
	\renewcommand{\newlineTOC}{}%
	\onlyAuthor\@author}}
\newcommand{\lsCollectionPaperHeaderTitle}{%
	\renewcommand{\newlineCover}{}
	\renewcommand{\newlineTOC}{}
	\iflsCollectionChapter%
		\thechapter\hspace{0.5em}\fi
	\@title}
\newcommand{\lsCollectionPaperTOC}{{%
	\iflsCollectionChapter%
		\protect\numberline{\thechapter}\fi
	\@title\newline{\normalfont\@author}}}
\newcommand{\lsCollectionPaperTitle}{{%
	\renewcommand{\newlineTOC}{}
	\renewcommand{\newlineCover}{\\}
	\iflsCollectionChapter
		\vspace*{-2\baselineskip} 
		{\LARGE Chapter \thechapter}\newline\newline\fi
	\@title}}
\newcommand{\lsCollectionPaperAuthor}{{%
	\renewcommand{\newlineTOC}{}
	\renewcommand{\newlineCover}{\\[0.5ex]}
	\AuthorAffiliation\Large\@author}}
\newcommand{\lsCollectionPaperCitation}{\scalebox{1.2}{
	\includegraphics{\logopath/langsci_spinelogo_nocolor.pdf}}%
	\hspace{0.8em}%
	\parbox[b]{.85\textwidth}{\linespread{0.8}\small\normalfont\lsCollectionPaperCitationText}}
\newcommand{\lsCollectionPaperCitationText}{\string\lsCollectionPaperCitationText.}
\newcommand{\lsPaper}{
	\renewcommand{\maketitle}{
		\addtocounter{chapter}{1}
		\addchap*{\lsCollectionPaperTitle}
		\global\edef\lsCollectionPaperFirstPage{\thepage}	% for citation in footer
		\onlyAuthor
		\renewcommand{\newlineCover}{}
		\renewcommand{\newlineTOC}{\\}
		\addcontentsline{toc}{chapter}{\lsCollectionPaperTOC}%
		\ifoot[\lsCollectionPaperCitation]{\iflsDraft Draft of \today, \currenttime \fi}
		\vspace*{-2ex}
		\lsCollectionPaperAuthor%
		\vspace*{\baselineskip}%
		\ifx\@epigram\empty%
			\else {\epigraph{\@epigram\\[-5ex]}{\@epigramsource}% 
					\epigram{}\epigramsource{}}% 
		\fi% 
		\begin{quote}
		\small\lsCollectionPaperAbstract
		\end{quote}
	}	

	\renewcommand*{\thesection}{\arabic{section}}
	\setcounter{section}{0}
	\setcounter{footnote}{0}
	\setcounter{figure}{0}
	\setcounter{table}{0}
	\setcounter{equation}{0}  % for examples
	\ohead{}
	\lehead{\lsCollectionPaperHeaderAuthor}
	\rohead{\lsCollectionPaperHeaderTitle}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Ouput types:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Output types are defined with \newcommand above so they can be used width geometry.

\AtBeginDocument{
\ifx\lsOutput\lsOutputPaper				% only if output=paper
	\usepackage{chngcntr}
	\counterwithout{figure}{chapter}
	\counterwithout{table}{chapter}
	\lsPaper
\else									% only if output!=paper
\renewcommand{\maketitle}{
\begin{titlepage}
\thispagestyle{empty}

\ifx\lsOutput\lsOutputLong				% only if output=long
	\setcounter{page}{-3}
	%% First titlepage:
	{\lsFrontPage}
	%%%%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	\null\newpage\thispagestyle{empty}
	%% Back page:
	{\lsBackPage}
	%%%%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	\null\newpage\thispagestyle{empty}
	%% Book spine:
	{\lsSpine}
	%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	\null\newpage\thispagestyle{empty}
	%% Series information:
	{\lsSeriesHistory}
	%%%%%%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	%% Schmutztitel:
	{\renewcommand{\lsCoverBlockColor}{white}
	 \renewcommand{\lsCoverFontColor}{\lsSeriesColor}
	\lsSchmutztitel}
	%%%%%%%%%%%%%%%%%%%%
	\AtEndDocument{
		\lsPageStyleEmpty
		\null\newpage\thispagestyle{empty}
		%% Advertisement:
		{\lsAdvertisement}
	}
\fi		

\ifx\lsOutput\lsOutputShort						% only if output=short
	\setcounter{page}{-1}
	%% First titlepage:
	{\lsFrontPage}
	%%%%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	\null\newpage\thispagestyle{empty}
	%% Series information:
	{\lsSeriesHistory}
	%%%%%%%%%%%%%%%%%%%%%
	\newpage\thispagestyle{empty}
	%% Schmutztitel:
	{\renewcommand{\lsCoverBlockColor}{white}
	 \renewcommand{\lsCoverFontColor}{\lsSeriesColor}
	\lsSchmutztitel}
	%%%%%%%%%%%%%%%%%%%%
	\AtEndDocument{
		\lsPageStyleEmpty
		\null\newpage\thispagestyle{empty}
		%% Advertisement:
		{\lsAdvertisement}
		\null\newpage\thispagestyle{empty}
		%% Back page:
		{\lsBackPage}
		\null\newpage\thispagestyle{empty}
	}
\fi

\ifx\lsOutput\lsOutputInprep					% only if output=inprep
	{\renewcommand{\lsCoverBlockColor}{white}
	 \renewcommand{\lsCoverFontColor}{black}
	 \lsCoverBlock
	 \lsCoverTitleAuthor}
\fi								

\ifx\lsOutput\lsOutputGuidelines				% only if output=guidelines
	{\setcounter{page}{-1}
	%% First titlepage:
	{\lsFrontPage}}
\fi

\ifx\lsOutput\lsOutputCoverBOD				 % only if output=cover 
	\renewcommand{\maketitle}{}  %no need for this
	\StrLen{\@subtitle}[\subtitleStrLen]     % check if a subtitle exists
	\pagestyle{empty}
	\pgfdeclarelayer{lspcls_bg} % Please make sure to never use lspcls_... PGF layers in any document
	\pgfsetlayers{lspcls_bg,main}
	\iflsCollection% Check for Collection option
		\IfSubStr{\@author}{\&}	 	% if \@author contains \&
		{\renewcommand{\lsEditorSuffix}{\xspace(eds.)}}
		{\IfSubStr{\@author}{,}	% if \@author contains ,
			{\renewcommand{\lsEditorSuffix}{\xspace(eds.)}}
			{\renewcommand{\lsEditorSuffix}{\xspace(ed.)}}}	
		\renewcommand{\lsEditorPrefix}{{\LARGE Edited by}\\}
	\else
			\renewcommand{\lsEditorPrefix}{}
	\fi
	\begin{tikzpicture}[remember picture, overlay,bg/.style={outer sep=0}]
	\begin{pgfonlayer}{lspcls_bg} % background layer
	\node [bg, left = 24.5mm of current page.east, fill=\lsSeriesColor, minimum height=23.1cm, minimum width=15.2cm] (lspcls_bg1) {}; % Die können wir noch dynamisch bestimmen
	\node [bg, right = 24.5mm of current page.west, fill=\lsSeriesColor, minimum height=23.1cm, minimum width=15.2cm] (lspcls_bg2) {};
	\node at (current page.center) [bg, minimum height=24.6cm, minimum width=\totalspine,dashed] (lspcls_bgspline) {}; % add draw option for preview mode 
	\end{pgfonlayer}
	
	%% Text and Graphics Layer
	
	%% Spine
	\renewcommand{\newlineCover}{}
	\node [above = 7.5mm of lspcls_bgspline.south] (lspcls_splinelogo) {\color{\lsSeriesColor}\includegraphics{\logopath/langsci_spinelogo_nocolor.pdf}};
	\node [font=\fontsize{18pt}{14pt}\selectfont, above left = 15mm and 4mm of lspcls_splinelogo.north, rotate=270] (lspcls_splinetitle) {\color{\lsSeriesColor} \lsSpineAuthorFont{\lsSpineAuthor\lsEditorSuffix} \hspace{13mm} \lsSpineTitleFont{\@title}}; 
	\renewcommand{\newlineCover}{\\}

	%% Book Cover
	
	\newcommand{\lsCoverFontColour}{white}
	
	\node [execute at begin node={}, font=\fontsize{52pt}{16.75mm}\selectfont, below right = 10mm and 7.5mm of lspcls_bg1.north west, text width=13.7cm, align=left] (lspcls_covertitle) {\color{\lsCoverFontColour}\lsCoverTitleFont{\@title\par}}; % x = 15mm - 7.5mm ; y = 17.5mm - 7.5mm
	
	\ifnum\subtitleStrLen=0  % Is there a subtitle?
	\node [font=\fontsize{25pt}{12.5mm}\selectfont, right, below = 11.2mm of lspcls_covertitle.south, text width=137mm] {\color{\lsCoverFontColour}\lsCoverAuthorFont\nohyphens{\lsEditorPrefix\@author\par}}; % If not, just print the author
	\else
	\node [font=\fontsize{25pt}{10mm}\selectfont,below = 8mm of lspcls_covertitle.south, text width=137mm] (lspcls_coversubtitle) {\color{\lsCoverFontColour} \lsCoverSubTitleFont \nohyphens{\@subtitle}\par}; 
	\node [font=\fontsize{25pt}{12.5mm}\selectfont, right, below = 11.2mm of lspcls_coversubtitle.south, text width=137mm] {\color{\lsCoverFontColour}\lsCoverAuthorFont{\nohyphens{\lsEditorPrefix\@author\par}}};
	\fi
	
	\node [above left = 10mm and 7.5mm of lspcls_bg1.south east] {\color{\lsCoverFontColour}\includegraphics{\logopath/langsci_logo_nocolor.pdf}};
	\node [above right = 18.5mm and -.1mm of lspcls_bg1.south west, rectangle, fill=white, minimum size=17pt] (lspcls_square) {}; % 2
	\path let \p1 = (lspcls_square.north east), \p2 = (lspcls_covertitle.west) in node at (\x2,\y1) (lspcls_seriesinfo) [font=\fontsize{17pt}{7.5mm}\selectfont, right, text width=95mm, anchor=north west] {\color{\lsCoverFontColour}\lsCoverSeriesFont{\lsSeriesTitle\par}};
	
	%% Book Back Cover
	\node [font=\fontsize{25pt}{10mm}\selectfont, right, below right = 16.5mm and 7.5mm of lspcls_bg2.north west, text width=11.5cm] (lspcls_backtitle) {\color{\lsCoverFontColour}\lsBackTitleFont{\lsBackTitle\par}};
	\node [below = 10mm of lspcls_backtitle, text width=11.5cm, align=justify] {\color{\lsCoverFontColour}\lsBackBodyFont{\parindent=15pt\lsBackBody}};
	%\node [below right = 192.5mm and 97.5mm of lspcls_bg2.north west] {\color{\lsCoverFontColour}ISBN \lsBackBodyFont{\lsISBN}};
	\node [below right = 192.5mm and 97.5mm of lspcls_bg2.north west, text width=4cm] {
		\colorbox{white}{
			\begin{pspicture}(0,0)(4.1,1in)
			\psbarcode[transx=.4,transy=.3]{\lsISBNhardcover}{includetext height=.7}{isbn}\end{pspicture}}};
	
	%% Guiding Lines
	%\draw [red, thick, dashed] (lspcls_covertitle.west) -- (lspcls_seriesinfo.west);
	
	%	\node [below right=17mm and 17mm of current page.north west] (GL1) {};
	%	\node [above left=17mm and 17mm of current page.south east] (GL2) {};
	%	\draw [dashed, orange, thick] (GL1) -| (GL2) -| (GL1);
	%	
	
	\end{tikzpicture} 
	\end{titlepage}
	\end{document}     % the cover and nothing else.
	\fi	
	
	\ifx\lsOutput\lsOutputCoverCS	 			 % only if output=covercs 	
	\renewcommand{\maketitle}{}  				 % no need for this 			
	\StrLen{\@subtitle}[\subtitleStrLen]     % check if a subtitle exists
	\pagestyle{empty}
	\pgfdeclarelayer{lspcls_bg} % Please make sure to never use lspcls_... PGF layers in any document
	\pgfsetlayers{lspcls_bg,main}
	\iflsCollection% Check for Collection option
	\IfSubStr{\@author}{\&}	 	% if \@author contains \&
	{\renewcommand{\lsEditorSuffix}{\xspace(eds.)}}
	{\IfSubStr{\@author}{,}	% if \@author contains ,
		{\renewcommand{\lsEditorSuffix}{\xspace(eds.)}}
		{\renewcommand{\lsEditorSuffix}{\xspace(ed.)}}}	
	\renewcommand{\lsEditorPrefix}{{\LARGE Edited by}\\}
	\else
	\renewcommand{\lsEditorPrefix}{}
	\fi
	\begin{tikzpicture}[remember picture, overlay,bg/.style={outer sep=0}]
	\begin{pgfonlayer}{lspcls_bg} % background layer
	\node [bg, left = 10.675mm of current page.east, fill=\lsSeriesColor, minimum height=22.5cm, minimum width=15.5cm] (lspcls_bg1) {}; % Die können wir noch dynamisch bestimmen % 7.5mm -> 10.675mm for bleed
	\node [bg, right = 10.675mm of current page.west, fill=\lsSeriesColor, minimum height=22.5cm, minimum width=15.5cm] (lspcls_bg2) {};
	\node at (current page.center) [bg, minimum height=24cm, minimum width=\spinewidth,dashed] (lspcls_bgspline) {}; % add [draw] option for preview mode 
	\end{pgfonlayer}
	
	%% Text and Graphics Layer
	
	%% Spine
	\renewcommand{\newlineCover}{}
	\node [above = 10.675mm of lspcls_bgspline.south] (lspcls_splinelogo) {\color{\lsSeriesColor}\includegraphics{\logopath/langsci_spinelogo_nocolor.pdf}};
	\node [font=\fontsize{18pt}{14pt}\selectfont, above left = 15mm and 4mm of lspcls_splinelogo.north, rotate=270] (lspcls_splinetitle) {\color{\lsSeriesColor} \lsSpineAuthorFont{\lsSpineAuthor\lsEditorSuffix} \hspace{13mm} \lsSpineTitleFont{\@title}};
	\renewcommand{\newlineCover}{\\} 
	
	%% Book Cover
	
	\newcommand{\lsCoverFontColour}{white}
	
	\node [execute at begin node={}, font=\fontsize{52pt}{16.75mm}\selectfont, below right = 10mm and 7.5mm of lspcls_bg1.north west, text width=140mm, align=left] (lspcls_covertitle) {\color{\lsCoverFontColour}\lsCoverTitleFont{\@title\par}}; % x = 15mm - 7.5mm ; y = 17.5mm - 7.5mm
	
	\ifnum\subtitleStrLen=0  % Is there a subtitle?
	\node [font=\fontsize{25pt}{12.5mm}\selectfont, right, below = 11.2mm of lspcls_covertitle.south, text width=140mm] {\color{\lsCoverFontColour}\lsCoverAuthorFont\nohyphens{\lsEditorPrefix\@author\par}}; % If not, just print the author
	\else
	\node [font=\fontsize{25pt}{10mm}\selectfont, right, below = 8mm of lspcls_covertitle.south, text width=140mm] (lspcls_coversubtitle) {\color{\lsCoverFontColour} \lsCoverSubTitleFont \nohyphens{\@subtitle\par}}; 
	\node [font=\fontsize{25pt}{12.5mm}\selectfont, right, below = 11.2mm of lspcls_coversubtitle.south, text width=140mm] {\color{\lsCoverFontColour}\lsCoverAuthorFont\nohyphens{\lsEditorPrefix\@author\par}};
	\fi
	
	\node [below right = 197.5mm and 117.1mm of lspcls_bg1.north west] {\color{\lsCoverFontColour}\includegraphics{\logopath/langsci_logo_nocolor.pdf}};
	\node [above right = 18.5mm and -.1mm of lspcls_bg1.south west, rectangle, fill=white, minimum size=17pt] (lspcls_square) {}; % 2
	\path let \p1 = (lspcls_square.north east), \p2 = (lspcls_covertitle.west) in node at (\x2,\y1) (lspcls_seriesinfo) [font=\fontsize{17pt}{7.5mm}\selectfont, right, text width=95mm, anchor=north west] {\color{\lsCoverFontColour}\lsCoverSeriesFont{\lsSeriesTitle\par}};
	
	%% Book Back Cover
	\node [font=\fontsize{25pt}{10mm}\selectfont, right, below right = 16.5mm and 7.5mm of lspcls_bg2.north west, text width=11.5cm] (lspcls_backtitle) {\color{\lsCoverFontColour}\lsBackTitleFont{\lsBackTitle\par}};
	\node [below = 10mm of lspcls_backtitle, text width=11.5cm, align=justify] {\color{\lsCoverFontColour}\lsBackBodyFont{\parindent=15pt\lsBackBody}};
	%\node [below right = 192.5mm and 97.5mm of lspcls_bg2.north west] {\color{\lsCoverFontColour}ISBN \lsBackBodyFont{\lsISBN}};
	\node [below right = 192.5mm and 97.5mm of lspcls_bg2.north west, text width=4cm] {
		\colorbox{white}{
			\begin{pspicture}(0,0)(4.1,1in)
			\psbarcode[transx=.4,transy=.3]{%
				\iflsUscover\lsISBNsoftcoverus\else\lsISBNsoftcover\fi
				}{includetext height=.7}{isbn}\end{pspicture}}};
	\end{tikzpicture} 
	\end{titlepage}
	\end{document}     % the cover and nothing else.
	\fi		
	
\end{titlepage}

\frontmatter
\renewcommand{\frontmatter}{}

\null\newpage\thispagestyle{empty}
\hypersetup{colorlinks=false, pdfborder={0 0 0}} 	% for hyperref
\color{black}
\lsInsideFont

%% Imprint:
\ifx\lsOutput\lsOutputInprep{}
\else{
	\ifx\lsOutput\lsOutputGuidelines{}
	\else{\lsImpressum}
	\fi}
\fi
%%%%%%%%%%%%%

\null\newpage\thispagestyle{plain}
%\pagenumbering{roman}		% or \frontmatter

%% Dedication:
\ifx\@dedication\empty{}
\else{\lsDedication}
\fi
%%%%%%%%%%%%%%%%

}	%% \maketitle
\fi

%% for those who like the example in numbered example sentences to be typeset in italics
%% this is possible for a complete series only.
\ifx\lsSeries\sidl
	%\def\exfont{\normalsize\itshape}
	\renewcommand{\eachwordone}{\itshape} % only \gll
	
	\let\oldtable\table 	% footnotes in tables without horizontal line
	\let\endoldtable\endtable
	\renewenvironment{table}{\setfootnoterule{0pt}\oldtable}{\endoldtable} 
\fi

}	%% \AtBeginDocument


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Series history:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\lsSeriesHistory}{
\color{black}
\raggedright\lsCoverSeriesHistoryFont

\IfFileExists{./langsci/seriesinfo/\lsSeries-info.tex}{\input{./langsci/seriesinfo/\lsSeries-info}}{
  Series information: ./langsci/seriesinfo/\lsSeries-info.tex not found!} 

\IfStrEq{\lsISSN}{??}		% \IfStrEq from xstring
	{}
	{\vfill\hfill ISSN: \lsISSN}

}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Imprint:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\lsImpressumCitationText}{
	\onlyAuthor
	\renewcommand{\newlineCover}{}
	\renewcommand{\newlineSpine}{}
	{\@author}\if\lsEditorSuffix\empty\else\ \lsEditorSuffix\fi. %
	{\the\year}. %
	\textit{\@title}\if\@subtitle\empty\else: \textit{\@subtitle}\fi\ %
	(\lsSeriesTitle). %
	柏林：语言科学出版社。
%	Berlin: Language Science Press.
}

\newcommand{\lsImpressum}{
\raggedright

\lsImpressumCitationText

\vfill

本书可在以下网址获取： \\
%This title can be downloaded at:\\
\url{\lsURL}

© \the\year, \iflsCollection the authors\else\@author\fi

\newcommand{\ccby}{CC-BY} 
\ifx\lsCopyright\ccby 
本书的发表采用创作共用许可证4.0（CC BY 4.0）授权：
%Published under the Creative Commons Attribution 4.0 Licence (CC BY 4.0):
http://creativecommons.org/licenses/by/4.0/ 
\else
本书的发表采用创作共用许可证—禁止演绎4.0（CC BY-ND 4.0）授权：
%Published under the Creative Commons Attribution-NoDerivatives 4.0 Licence (CC BY-ND 4.0):
http://creativecommons.org/licenses/by-nd/4.0/ 
\fi

\noindent 
\begin{tabular}{@{}llrl@{; }r@{~}l}
ISBN: & \multicolumn{2}{r}{完整电子版：} & \lsISBNdigital \\
      &	精装：& vol1:        & \lsISBNhardcoverOne & vol. 2 & \lsISBNhardcoverTwo\\
      &	简装：& vol1:        & \lsISBNsoftcoverOne & vol. 2 & \lsISBNsoftcoverTwo\\
      &	美版简装：& vol1:        & \lsISBNsoftcoverusOne & vol. 2 & \lsISBNsoftcoverusTwo \\
%ISBN: & \multicolumn{2}{r}{Digital, complete work:} & \lsISBNdigital \\
%      &	Hardcover: & vol1:        & \lsISBNhardcoverOne & vol. 2 & \lsISBNhardcoverTwo\\
%      &	Softcover: & vol1:        & \lsISBNsoftcoverOne & vol. 2 & \lsISBNsoftcoverTwo\\
 %     &	Softcover US: & vol1:        & \lsISBNsoftcoverusOne & vol. 2 & \lsISBNsoftcoverusTwo \\
\end{tabular}

\IfStrEq{\lsISSN}{??}		% \IfStrEq from xstring
	{}
	{ISSN: \lsISSN}

\IfStrEq{\lsBookDOI}{??}		% \IfStrEq from xstring
	{}
	{\doi{\lsBookDOI}}


\bigskip

封面设计： 
%Cover and concept of design:
Ulrike Harbort \\
\if\@translator\empty\else
翻译：
%Translators:
\@translator \\
\fi
\if\@typesetter\empty\else
排版：
%Typesetting:
\@typesetter \\
\fi
\if\@illustrator\empty\else
插图：
%Illustration:
\@illustrator \\
\fi
\if\@proofreader\empty\else
校对：
%Proofreading:
\@proofreader \\
\fi
\if\@openreviewer\empty\else
公开评审：
%Open reviewing:
\@openreviewer \\
\fi
字体：Linux Libertine, Arimo, DejaVu Sans Mono\lsAdditionalFontsImprint\\
%Fonts: Linux Libertine, Arimo, DejaVu Sans Mono\lsAdditionalFontsImprint\\
排版软件：\XeLaTeX
%Typesetting software: \XeLaTeX


\bigskip

%语言科学出版社\\
Language Science Press\\
Unter den Linden 6\\
10099 Berlin, Germany\\
\href{http://langsci-press.org}{langsci-press.org}

\vfill

本书由柏林自由大学存储和编目 \\[3ex]
%Storage and cataloguing done by FU Berlin \\[3ex]  

\IfFileExists{\logopath/FULogo_sw_CMYK.pdf}{\includegraphics[width=5cm]{\logopath/FULogo_sw_CMYK.pdf}}{FU-Logo} \\[3ex]

\vfill

\noindent
本书的出版机构语言科学出版社不负责保证外部或第三方网址保持不变或者准确性，也不能保证这些网站内容是（或者保持）准确和合理的。
%\lsp has no responsibility for the persistence or accuracy of URLs for
%external or third-party Internet websites referred to in this
%publication, and does not guarantee that any content on such websites
%is, or will remain, accurate or appropriate. 
%Information regarding prices, travel timetables and other factual information given in this work are correct at the time of first publication but \lsp does not guarantee the accuracy of such information thereafter. 
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Dedication:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\lsDedication}{
	\vspace*{.2\textheight}	
	\begin{center}
		{\lsDedicationFont
		 \@dedication }
	\end{center}
	\vfill
	\clearpage}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Footnotes:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifxetex
\addtokomafont{footnote}{\addfontfeatures{Numbers=Lining}} 			% numbers in footnotes
%\addtokomafont{footnotelabel}{\addfontfeatures{Numbers=Lining}} 	% numbers in footnote labels
%\addtokomafont{footnotereference}{\addfontfeatures{Numbers=Lining}} 	% numbers in footnote references
\fi

\raggedbottom
\deffootnote[1.5em]{1.5em}{\normalparindent}{\textsuperscript{\thefootnotemark}\ }
\newlength{\normalparindent}
\AtBeginDocument{\setlength{\normalparindent}{\parindent}}

\KOMAoptions{footnotes=multiple}

%% http://tex.stackexchange.com/questions/28465/multiple-footnotes-at-one-point/71015#71015
\let\oldFootnote\footnote
\newcommand\nextToken\relax

\renewcommand\footnote[1]{%
	\oldFootnote{#1}\futurelet\nextToken\isFootnote}

\newcommand\isFootnote{%
	\ifx\footnote\nextToken\textsuperscript{,}\fi}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Collection:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iflsCollection
	\iflsBiblatex\else
		\ClassError{langsci/langscibook}{Collection option not compatible with plain BibTeX. Please use biblatex option}{}
	\fi
	
\renewcommand{\lsEditorPrefix}{{\LARGE Edited by}\\}
\AtBeginDocument{	% for the citation in the footer
	\onlyAuthor
	\renewcommand{\newlineCover}{}
	\renewcommand{\newlineSpine}{} 
	\edef\lsCollectionTitle{\@title}		% \edef immediately expands \@title
	\edef\lsCollectionEditor{\@author}
	\addbibresource{collection_tmp.bib}
	\newwrite\tempfile						% open temporary bib file
	\immediate\openout\tempfile=collection_tmp.bib
}
\AtEndDocument{\immediate\closeout\tempfile}% close temporary bib file

%% customize \tableofcontents
\renewcommand{\@dotsep}{2.5}		% space between dots
\renewcommand{\@tocrmarg}{1.5em}	% right margin for leader 
\renewcommand{\@pnumwidth}{1.5em}	% width of page numbers
\usepackage{tocstyle}
\usetocstyle{standard}				%\usetocstyle{allwithdot}
\iflsCollectionTOCLong\else
	\setcounter{tocdepth}{0}\fi			% show only parts and chapters
\settocstylefeature[-1]{pagenumberbox}{\csname @gobble\endcsname}	% parts without page number
\settocstylefeature[-1]{leaders}{\hfill}							% parts without dots#
	
\usepackage{chngcntr}
\counterwithout{figure}{chapter}
\counterwithout{table}{chapter}

%% Modified code from:
%% http://pastcounts.wordpress.com/2010/12/20/how-to-construct-a-collection-of-articles-with-latex/
\newenvironment{collectionpaper}{
	\renewcommand{\documentclass}[2][]{}%
	\renewcommand{\usepackage}[2][]{}%
	\renewenvironment{document}{\begingroup}{\endgroup}%

	\renewcommand{\title}[1]{\renewcommand{\@title}{##1}}
	\renewcommand{\author}[1]{\renewcommand{\@author}{##1}}
	%\renewcommand{\thanks}[1]{\symbolfootnote[1]{##1}}
	\lsPaper
	}
	{}

\newcommand{\includepaper}[1]{
	\begin{collectionpaper}
	\begin{refsection}

	\DeclareCiteCommand{\fullciteFooter}
		{\defcounter{maxnames}{\blx@maxbibnames}%
		  \usebibmacro{prenote}}
		{\usedriver
		   {\DeclareNameAlias{sortname}{default}}
		   {\thefield{entrytype}}}
		{\multicitedelim}
		{\usebibmacro{postnote}}
	\renewcommand{\lsCollectionPaperCitationText}{\fullciteFooter{#1}} 
	
	\include{#1}%
	\edef\lsCollectionPaperLastPage{\thepage}	% \lsCollectionPaperFirstPage is defined in \lsPaper

	%%% for citation in footer
	%% preprocessing of author/editor names
	\onlyAuthor		
	\renewcommand{\newlineCover}{}
	\renewcommand{\newlineSpine}{}
	\renewcommand{\newlineTOC}{}
	\StrSubstitute{\@author}{,}{ and }[\authorTemp]
	\StrSubstitute{\authorTemp}{\&}{ and }[\authorTemp]
	\StrSubstitute{\lsCollectionEditor}{,}{ and }[\editorTemp]
	\StrSubstitute{\editorTemp}{\&}{ and }[\editorTemp]

	%% write bib entry to file
	%% FIXME: the publisher field needs a final period, since this is not provided by \fullciteFooter together with DOIs.
	\immediate\write\tempfile{@incollection{#1,author={\authorTemp},title={\@title},booktitle={\lsCollectionTitle},editor={\editorTemp},publisher={语言科学出版社},Address={柏林},year=\the\year,pages={\lsCollectionPaperFirstPage --\lsCollectionPaperLastPage},doi={\lsChapterDOI},options={skipbib=true}}}
%\immediate\write\tempfile{@incollection{#1,author={\authorTemp},title={\@title},booktitle={\lsCollection%Title},editor={\editorTemp},publisher={Language Science %Press.},Address={Berlin},year=\the\year,pages={\lsCollectionPaperFirstPage --%\lsCollectionPaperLastPage},doi={\lsChapterDOI},options={skipbib=true}}} 
	\end{refsection}
	\end{collectionpaper}}
\fi


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    subsubsubsection:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{secnumdepth}{4} 

\def\subsubsubsection{\@startsection{paragraph}{3}{\z@}{-3.25ex plus
	-1ex minus-.2ex}{1.5ex plus.2ex}{\reset@font\normalsize}}

\let\subsubsubsectionmark\@gobble%

\def\subsubsubsubsection{\@startsection{subparagraph}{3}{\z@}{-3.25ex plus
	-1ex minus-.2ex}{1.5ex plus.2ex}{\reset@font\normalsize}}

\let\subsubsubsubsectionmark\@gobble

%% needed for hyperref
\def\toclevel@subsubsubsection{4}   


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%    Miscellaneous:
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[figuresright]{rotating}

%% gets rid of the warnings:
%% Failed to convert input string to UTF16
%% http://tex.stackexchange.com/questions/66722/tex-live-2012-xelatex-moderncv-error-failed-to-convert-input-string-to-utf1
\hypersetup{unicode,pdfencoding=auto,bookmarksopenlevel=0}
 
%% this is required by authorindex
\newif\ifshowindex \showindexfalse

\usepackage{authorindex}

%% quotes are indented at one side only.
\renewenvironment{quote}
			   {\list{}{\rightmargin0pt\leftmargin8mm}%{\rightmargin\leftmargin}%
				\item\relax}
			   {\endlist}

%% quotations are indented at one side only
%% there is no indentation at the beginning of the quote
\renewenvironment{quotation}
			   {\list{}{\listparindent 1.5em%
						%\itemindent    \listparindent
						%\rightmargin   \leftmargin
						\parsep        \z@ \@plus\p@}%
				\item\relax}
			   {\endlist}


%% useful commands for glossings:
\usepackage{./langsci/styles/langsci-lgr}

%% hspace over width of something without showing it
\newlength{\LSPTmp}
\newcommand*{\hspaceThis}[1]{\settowidth{\LSPTmp}{#1}\hspace*{\LSPTmp}}

%%% epigraph configuration
\usepackage{epigraph}
\setlength{\epigraphrule}{0pt}
\renewcommand{\textflush}{flushepinormal}
%\setlength{\epigraphwidth}{.2\textwidth}
\setlength{\afterepigraphskip}{0\baselineskip}

\usepackage{./langsci/styles/langsci-basic}

%% floats
%% http://mintaka.sdsu.edu/GF/bibliog/latex/floats.html
%% Alter some LaTeX defaults for better treatment of figures:

    %% See p.105 of "TeX Unbound" for suggested values.
    %% See pp. 199-200 of Lamport's "LaTeX" book for details.
    %%   General parameters, for ALL pages:
    \renewcommand{\topfraction}{0.9}	% max fraction of floats at top
    \renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
    %%   Parameters for TEXT pages (not float pages):
    \setcounter{topnumber}{2}
    \setcounter{bottomnumber}{2}
    \setcounter{totalnumber}{4}     % 2 may work better
    \setcounter{dbltopnumber}{2}    % for 2-column pages
    \renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
    \renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
    %%  Parameters for FLOAT pages (not text pages):
    \renewcommand{\floatpagefraction}{0.7}	% require fuller float pages
	%% N.B.: floatpagefraction MUST be less than topfraction !!
    \renewcommand{\dblfloatpagefraction}{0.7}	% require fuller float pages

\iflsShowIndex	% shows index commands in text
	\usepackage{soul}
	\usepackage[textwidth=2cm
		]{todonotes}
	\usepackage[noadjust]{marginnote}
	\renewcommand{\marginpar}{\marginnote}
	\let\isold\is 
	\renewcommand{\isi}[1]{\sethlcolor{green}\hl{#1}\isold{#1}}
	\renewcommand{\is}[1]{\todo[color=green,size=\scriptsize]{\tiny#1}\isold{#1}}
\fi


\endinput
